FROM ubuntu:20.04

RUN apt-get update && apt-get install -y locales && \
    locale-gen ko_KR.UTF-8 && \
    update-locale LANG=ko_KR.UTF-8

ENV DEBIAN_FRONTEND=noninteractive \
    JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64 \
    LANG=ko_KR.UTF-8 \
    LANGUAGE=ko_KR.UTF-8 \
    LC_ALL=ko_KR.UTF-8
ENV PATH="${JAVA_HOME}/bin:${PATH}"

# 필수 패키지 + openssh-server + python3-venv 추가
RUN apt-get update && apt-get install -y \
    wget \
    git \
    python3 \
    python3-pip \
    python3-venv \
    openjdk-8-jdk \
    fonts-nanum* \
    openssh-server \
    && rm -rf /var/lib/apt/lists/*

RUN mkdir /var/run/sshd

# SSH 비밀번호 로그인 및 root 로그인 허용 설정
RUN echo 'root:1234' | chpasswd
RUN sed -ri 's/^#?PasswordAuthentication\s+.*/PasswordAuthentication yes/' /etc/ssh/sshd_config && \
    sed -ri 's/^#?PermitRootLogin\s+.*/PermitRootLogin yes/' /etc/ssh/sshd_config

# 작업 디렉토리를 /app/python-hwplib 으로 설정
WORKDIR /app/python-hwplib
COPY . /app/python-hwplib

# python3-venv로 가상환경 생성
RUN python3 -m venv .venv

# 파이썬 패키지 설치 (가상환경 사용)
RUN . .venv/bin/activate && pip install flask requests JPype1==1.4.1 ipykernel

# 포트 노출
EXPOSE 7860
EXPOSE 22

# sshd 실행
CMD ["/usr/sbin/sshd", "-D"]
